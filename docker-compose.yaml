x-common: &common-setup
  network_mode: host
  ipc: host
  privileged: true
  volumes:
    - ${HOME}/.Xauthority:/home/mobile/.Xauthority:rw
    - .:/home/mobile/ros2_ws/src:rw
    - /tmp/.X11-unix:/tmp/.X11-unix:rw
    - /dev/dri:/dev/dri:rw
  working_dir: /home/mobile/ros2_ws
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities: [gpu]

services:
  terminal:
    environment:
    - DISPLAY
    - QT_X11_NO_MITSHM=1
    - TELEMETRY_PROTO=udp   # <-- was PROTO=tcp (unused). Use the var your node reads.
    - TEL_HOST=0.0.0.0      # <-- bind wildcard, receives from host
    - TEL_PORT=5600
    image: fabook/cv:h-v0.0.1
    <<: *common-setup
    stdin_open: true  # dsocker run -i
    tty: true        # docker run -t
    command: []

  terminal-cuda:
    <<: *common-setup
    image: fabook/champ:pobeda
    stdin_open: true
    tty: true
    environment:
      - DISPLAY
      - QT_X11_NO_MITSHM=1
      - TELEMETRY_PROTO=udp
      - TEL_HOST=0.0.0.0
      - TEL_PORT=5600
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics,display

